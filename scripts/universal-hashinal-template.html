<div
  class="max-w-2xl mx-auto bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm"
  data-block-type="hashinal-universal"
>
  <div class="p-6 border-b border-gray-200 dark:border-gray-700">
    <div
      class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
    >
      <div>
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
          {{name}}
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
          by {{creator}}
        </p>
      </div>
      <div class="flex items-center space-x-2">
        <span
          class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200"
        >
          Topic ID: {{topicId}}
        </span>
      </div>
    </div>
  </div>

  <div class="p-6">
    <div
      id="content-display-{{topicId}}"
      class="relative rounded-lg overflow-hidden bg-gray-50 dark:bg-gray-800"
    >
      <div
        id="loading-{{topicId}}"
        class="flex items-center justify-center h-48 text-gray-500"
      >
        <div class="text-center">
          <svg
            class="mx-auto h-8 w-8 animate-spin text-gray-400"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <p class="mt-2 text-sm">Loading content...</p>
        </div>
      </div>

      <img
        id="image-{{topicId}}"
        class="w-full h-auto max-h-96 object-contain hidden"
        alt="{{name}}"
      />

      <div id="document-{{topicId}}" class="hidden">
        <div
          class="flex items-center space-x-4 p-4 bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-600"
        >
          <div class="flex-shrink-0">
            <svg
              id="doc-icon-{{topicId}}"
              class="w-12 h-12 text-blue-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              ></path>
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <p
              id="doc-name-{{topicId}}"
              class="text-sm font-medium text-gray-900 dark:text-white truncate"
            >
              Document
            </p>
            <p
              id="doc-info-{{topicId}}"
              class="text-sm text-gray-500 dark:text-gray-400"
            >
              File
            </p>
          </div>
        </div>
      </div>

      <div
        id="text-{{topicId}}"
        class="hidden bg-gray-900 dark:bg-gray-800 rounded p-4 max-h-64 overflow-auto"
      >
        <pre
          id="text-content-{{topicId}}"
          class="text-gray-300 font-mono text-xs whitespace-pre-wrap"
        ></pre>
      </div>

      <div id="generic-{{topicId}}" class="hidden">
        <div class="flex items-center space-x-3 p-4">
          <svg
            id="generic-icon-{{topicId}}"
            class="w-8 h-8 text-gray-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
            ></path>
          </svg>
          <div>
            <p
              id="generic-name-{{topicId}}"
              class="text-sm font-medium text-gray-900 dark:text-white"
            >
              Content
            </p>
            <p
              id="generic-info-{{topicId}}"
              class="text-xs text-gray-500 dark:text-gray-400"
            >
              Unknown type
            </p>
          </div>
        </div>
      </div>

      <div
        id="error-{{topicId}}"
        class="hidden flex items-center justify-center h-48 text-gray-500"
      >
        <div class="text-center">
          <svg
            class="mx-auto h-12 w-12 text-gray-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          <p class="mt-2 text-sm">Failed to load content</p>
        </div>
      </div>
    </div>
  </div>

  <div class="px-6 pb-4">
    <button
      id="metadata-toggle-{{topicId}}"
      class="flex items-center space-x-2 w-full text-left p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
      data-topic-id="{{topicId}}"
    >
      <svg
        id="metadata-chevron-{{topicId}}"
        class="w-4 h-4 text-gray-500 transform transition-transform"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 5l7 7-7 7"
        ></path>
      </svg>
      <span class="text-sm font-medium text-gray-900 dark:text-white"
        >Metadata</span
      >
      <span class="text-xs text-gray-500 dark:text-gray-400"
        >(HIP-412 JSON)</span
      >
    </button>
    <div
      id="metadata-content-{{topicId}}"
      class="hidden mt-3 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg font-mono text-sm overflow-auto max-h-96"
    >
      <div
        id="metadata-json-{{topicId}}"
        class="text-gray-800 dark:text-gray-200"
      ></div>
    </div>
  </div>

  <div class="px-6 pb-6">
    <div id="actions-{{topicId}}" class="flex flex-wrap gap-3"></div>
  </div>
</div>

<script>
  (function () {
    window.hashinalHandlers = window.hashinalHandlers || {};
    window.hashinalCache = window.hashinalCache || {};

    const topicId = '{{topicId}}';
    const hrl = '{{hrl}}';
    const network = '{{network}}' || 'testnet';

    // Environment detection for block-tester
    const isBlockTesterMode =
      typeof window !== 'undefined' &&
      (window.location?.href?.includes('localhost') ||
        window.location?.href?.includes('block-tester') ||
        document.querySelector('.block-preview-content') !== null);

    console.log('Hashinal template initializing:', {
      topicId,
      network,
      isBlockTesterMode,
      location: window.location?.href,
    });
    const handlers = {
      toggleMetadata: function () {
        const content = document.getElementById('metadata-content-' + topicId);
        const chevron = document.getElementById('metadata-chevron-' + topicId);
        if (content && chevron) {
          if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(90deg)';
          } else {
            content.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
          }
        }
      },

      download: function () {
        const cached = window.hashinalCache[topicId];
        if (cached && cached.contentUrl) {
          const a = document.createElement('a');
          a.href = cached.contentUrl;
          a.download = cached.fileName || 'hashinal-' + topicId;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }
      },

      viewFull: function () {
        const cached = window.hashinalCache[topicId];
        if (cached && cached.contentUrl) {
          window.open(cached.contentUrl, '_blank');
        }
      },

      share: function () {
        const cached = window.hashinalCache[topicId];
        const hashLink = cached ? cached.hrl : 'hcs://5/' + topicId;

        if (navigator.share) {
          navigator.share({
            title: 'Hashinal Content',
            text: 'Check out this Hashinal on Hedera',
            url: hashLink,
          });
        } else {
          navigator.clipboard.writeText(hashLink).then(function () {
            alert('HashLink copied to clipboard!');
          });
        }
      },
    };

    window.hashinalHandlers[topicId] = handlers;

    const toggleButton = document.getElementById('metadata-toggle-' + topicId);
    if (toggleButton) {
      toggleButton.addEventListener('click', function () {
        handlers.toggleMetadata();
      });
    }
    function hideAll() {
      ['loading', 'image', 'document', 'text', 'generic', 'error'].forEach(
        function (id) {
          const el = document.getElementById(id + '-' + topicId);
          if (el) el.classList.add('hidden');
        }
      );
    }

    function show(elementId) {
      const el = document.getElementById(elementId + '-' + topicId);
      if (el) {
        el.classList.remove('hidden');
      }
    }

    function formatFileSize(bytes) {
      if (!bytes || bytes === 'Unknown') return 'Unknown size';
      const size = parseInt(bytes);
      if (isNaN(size)) return 'Unknown size';

      const units = ['B', 'KB', 'MB', 'GB'];
      let i = 0;
      let fileSize = size;

      while (fileSize >= 1024 && i < units.length - 1) {
        fileSize /= 1024;
        i++;
      }

      return fileSize.toFixed(1) + ' ' + units[i];
    }

    function renderMetadata(metadata) {
      const container = document.getElementById('metadata-json-' + topicId);
      if (!container) return;

      const renderValue = function (value, level) {
        level = level || 0;
        const indent = '  '.repeat(level);

        if (Array.isArray(value)) {
          const items = value
            .map(function (item, index) {
              return renderValue(item, level + 1);
            })
            .join(',\n');
          return '[\n' + items + '\n' + indent + ']';
        }

        if (typeof value === 'object' && value !== null) {
          const entries = Object.keys(value)
            .map(function (k) {
              return (
                indent +
                '  <span class="text-purple-600 dark:text-purple-400">"' +
                k +
                '"</span>: ' +
                renderValue(value[k], level + 1)
              );
            })
            .join(',\n');
          return '{\n' + entries + '\n' + indent + '}';
        }

        if (typeof value === 'string') {
          return '<span class="text-green-500">"' + value + '"</span>';
        }

        if (typeof value === 'number') {
          return '<span class="text-blue-500">' + value + '</span>';
        }

        if (typeof value === 'boolean') {
          return '<span class="text-yellow-500">' + value + '</span>';
        }

        return '<span class="text-gray-500">null</span>';
      };

      container.innerHTML =
        '<pre class="whitespace-pre-wrap">' +
        renderValue(metadata, 0) +
        '</pre>';
    }

    function createActions(contentType) {
      const actionsContainer = document.getElementById('actions-' + topicId);
      if (!actionsContainer) return;

      actionsContainer.innerHTML = '';

      const actions = [];
      if (contentType === 'image') {
        actions.push({
          label: 'View Full Size',
          icon: 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7',
          color: 'blue',
          handler: 'viewFull',
        });
      } else {
        actions.push({
          label: 'Open',
          icon: 'M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14',
          color: 'purple',
          handler: 'viewFull',
        });
      }

      actions.push({
        label: 'Download',
        icon: 'M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
        color: 'green',
        handler: 'download',
      });

      actions.push({
        label: 'Share',
        icon: 'M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z',
        color: 'gray',
        handler: 'share',
      });

      actions.forEach(function (action) {
        const button = document.createElement('button');
        button.onclick = window.hashinalHandlers[topicId][action.handler];
        button.className =
          'inline-flex items-center px-4 py-2 border border-' +
          action.color +
          '-300 text-' +
          action.color +
          '-700 bg-' +
          action.color +
          '-50 hover:bg-' +
          action.color +
          '-100 dark:border-' +
          action.color +
          '-600 dark:text-' +
          action.color +
          '-300 dark:bg-' +
          action.color +
          '-900 dark:hover:bg-' +
          action.color +
          '-800 rounded-md text-sm font-medium transition-colors';

        button.innerHTML =
          '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="' +
          action.icon +
          '"></path></svg>' +
          action.label;

        actionsContainer.appendChild(button);
      });
    }

    async function loadContent() {
      try {
        console.log('Starting loadContent for topic:', topicId);
        const metadataUrl =
          'https://kiloscribe.com/api/inscription-cdn/' +
          topicId +
          '?network=' +
          network;

        console.log('Fetching metadata from:', metadataUrl);
        const response = await fetch(metadataUrl);
        const metadata = await response.json();
        console.log('Metadata received:', metadata);

        let contentUrl = '';
        let contentType = 'unknown';
        let mimeType = 'application/octet-stream';

        if (metadata.image) {
          const hcsMatch = metadata.image.match(/^hcs:\/\/(\d+)\/(0\.0\.\d+)$/);
          if (hcsMatch) {
            const contentTopicId = hcsMatch[2];
            contentUrl =
              'https://kiloscribe.com/api/inscription-cdn/' +
              contentTopicId +
              '?network=' +
              network;
          } else if (metadata.image.startsWith('http')) {
            contentUrl = metadata.image;
          }
        }
        console.log('Extracted content URL:', contentUrl);

        if (contentUrl) {
          try {
            console.log('Fetching content headers for:', contentUrl);
            const headResponse = await fetch(contentUrl, { method: 'HEAD' });
            console.log('HEAD response status:', headResponse.status);
            mimeType =
              headResponse.headers.get('content-type') ||
              'application/octet-stream';
            const contentLength = headResponse.headers.get('content-length');
            console.log('Content type:', mimeType, 'Length:', contentLength);

            if (mimeType.startsWith('image/')) {
              contentType = 'image';
            } else if (
              mimeType.includes('pdf') ||
              mimeType.includes('document')
            ) {
              contentType = 'document';
            } else if (
              mimeType.includes('text') ||
              mimeType.includes('json') ||
              mimeType.includes('javascript') ||
              mimeType.includes('css')
            ) {
              contentType = 'text';
            } else if (mimeType.includes('audio')) {
              contentType = 'audio';
            } else if (mimeType.includes('video')) {
              contentType = 'video';
            } else {
              contentType = 'generic';
            }

            console.log('Determined content type:', contentType);
            window.hashinalCache[topicId] = {
              metadata: metadata,
              contentUrl: contentUrl,
              contentType: contentType,
              mimeType: mimeType,
              contentLength: contentLength,
              fileName: metadata.name || 'hashinal-' + topicId,
              hrl: hrl,
            };
            console.log('Updated cache:', window.hashinalCache[topicId]);
          } catch (err) {
            console.warn('Could not fetch content headers:', err);
            // Fallback: assume it's an image if metadata says so
            if (metadata.type && metadata.type.startsWith('image/')) {
              contentType = 'image';
              mimeType = metadata.type;
              console.log(
                'Using metadata type as fallback:',
                contentType,
                mimeType
              );
            }
          }
        }

        console.log(
          'Starting display logic with contentUrl:',
          contentUrl,
          'contentType:',
          contentType
        );
        hideAll();

        if (!contentUrl) {
          console.log('No content URL, showing generic content');
          const genericName = document.getElementById(
            'generic-name-' + topicId
          );
          const genericInfo = document.getElementById(
            'generic-info-' + topicId
          );
          if (genericName)
            genericName.textContent = metadata.name || 'Hashinal Content';
          if (genericInfo)
            genericInfo.textContent = 'No media content - Metadata only';
          show('generic');
        } else if (contentType === 'image' && contentUrl) {
          console.log('Setting up image loading for:', contentUrl);
          const img = document.getElementById('image-' + topicId);
          if (img) {
            console.log('Found image element, setting src and event handlers');

            // Set up error handler first
            img.onerror = function () {
              console.log('Image failed to load via img element:', contentUrl);
              if (isBlockTesterMode) {
                console.log(
                  'Block tester mode: showing image info instead of error'
                );
                showImageFallback();
              } else {
                hideAll();
                show('error');
              }
            };

            // Set up load handler
            img.onload = function () {
              console.log('Image loaded successfully:', contentUrl);
              hideAll();
              show('image');
            };

            // Function to show image info when direct loading fails
            function showImageFallback() {
              console.log('Showing image fallback for block tester');
              const genericName = document.getElementById(
                'generic-name-' + topicId
              );
              const genericInfo = document.getElementById(
                'generic-info-' + topicId
              );
              const genericIcon = document.getElementById(
                'generic-icon-' + topicId
              );

              if (genericName)
                genericName.textContent = metadata.name || 'Image Content';
              if (genericInfo) {
                genericInfo.innerHTML = `
                  <div class="text-xs space-y-1">
                    <div>Type: ${mimeType}</div>
                    <div>URL: <a href="${contentUrl}" target="_blank" class="text-blue-500 hover:underline">View Image</a></div>
                    <div class="text-gray-400">Preview not available in Block Tester</div>
                  </div>
                `;
              }

              if (genericIcon) {
                genericIcon.innerHTML =
                  '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>';
                genericIcon.classList.remove('text-gray-500');
                genericIcon.classList.add('text-blue-500');
              }

              hideAll();
              show('generic');
            }

            // Set src after event handlers to ensure they're registered
            img.src = contentUrl;

            // Fallback for block-tester environment - check if image is already loaded
            if (isBlockTesterMode) {
              console.log(
                'Block tester mode detected, setting up fallback checks'
              );

              // Check if image is already complete (cached or loaded before handler attachment)
              setTimeout(function () {
                console.log('Checking image status after 100ms:', {
                  complete: img.complete,
                  naturalWidth: img.naturalWidth,
                  src: img.src,
                });
                if (img.complete && img.naturalWidth > 0) {
                  console.log('Image was already loaded, showing it now');
                  hideAll();
                  show('image');
                } else if (img.complete && img.naturalWidth === 0) {
                  console.log(
                    'Image failed to load (complete but no dimensions)'
                  );
                  showImageFallback();
                }
              }, 500);

              // Additional timeout fallback for CORS/network issues
              setTimeout(function () {
                console.log('Final check after 2 seconds:', {
                  hasHiddenClass: img.classList.contains('hidden'),
                  complete: img.complete,
                  naturalWidth: img.naturalWidth,
                });
                if (img.classList.contains('hidden')) {
                  console.log(
                    'Image still hidden after 2 seconds, checking status'
                  );
                  if (img.complete && img.naturalWidth > 0) {
                    console.log('Image loaded but still hidden, forcing show');
                    hideAll();
                    show('image');
                  } else {
                    console.log(
                      'Image failed to load within timeout - likely CORS/network issue in block tester'
                    );
                    showImageFallback();
                  }
                }
              }, 2000);
            }
          } else {
            console.error(
              'Could not find image element with id:',
              'image-' + topicId
            );
            hideAll();
            show('error');
          }
        } else if (contentType === 'document') {
          const docName = document.getElementById('doc-name-' + topicId);
          const docInfo = document.getElementById('doc-info-' + topicId);
          if (docName) docName.textContent = metadata.name || 'Document';
          if (docInfo)
            docInfo.textContent =
              mimeType +
              ' • ' +
              formatFileSize(window.hashinalCache[topicId].contentLength);
          show('document');
        } else if (contentType === 'text') {
          try {
            const textResponse = await fetch(contentUrl);
            const textContent = await textResponse.text();
            const textEl = document.getElementById('text-content-' + topicId);
            if (textEl) {
              textEl.textContent =
                textContent.substring(0, 2000) +
                (textContent.length > 2000 ? '...' : '');
            }
            show('text');
          } catch (err) {
            show('generic');
          }
        } else {
          const genericName = document.getElementById(
            'generic-name-' + topicId
          );
          const genericInfo = document.getElementById(
            'generic-info-' + topicId
          );
          if (genericName) genericName.textContent = metadata.name || 'Content';
          if (genericInfo)
            genericInfo.textContent =
              mimeType +
              ' • ' +
              formatFileSize(window.hashinalCache[topicId].contentLength);

          const icon = document.getElementById('generic-icon-' + topicId);
          if (icon) {
            if (contentType === 'audio') {
              icon.innerHTML =
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>';
              icon.classList.remove('text-gray-500');
              icon.classList.add('text-purple-500');
            } else if (contentType === 'video') {
              icon.innerHTML =
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>';
              icon.classList.remove('text-gray-500');
              icon.classList.add('text-red-500');
            }
          }

          show('generic');
        }

        if (metadata && Object.keys(metadata).length > 0) {
          renderMetadata(metadata);
        }

        createActions(contentType);
      } catch (error) {
        console.error('Failed to load Hashinal content:', error);
        hideAll();
        show('error');
      }
    }

    loadContent();
  })();
</script>
